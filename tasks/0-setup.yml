- name: 'Require mandatory variables'
  assert:
    that:
      - admin_username is defined
    fail_msg: "One or more required variables are missing."

# - name: Debug ansible_user
#   debug:
#     var: ansible_user
#     verbosity: "1"

# - name: "Set ansible_user"
#   set_fact:
#      ansible_user: "{{ admin_username }}"

# - name: Debug ansible_user
#   debug:
#     var: ansible_user
#     verbosity: "1"

- name: Determine if default user has access
  local_action: "command ssh -q -o BatchMode=yes -o ConnectTimeout=3 -l {{ admin_username }} {{ inventory_hostname }} 'echo ok'"
  register: test_user
  ignore_errors: true
  changed_when: false

- name: Debug test_user
  debug:
    var: test_user
    verbosity: "1"

- name: "Get Facts : Get public IP address"
  ipify_facts:
  register: ansible_host_public_ip
  delegate_to: localhost
  run_once: true

- name: "Get Facts : Set ansible_host_public_ip"
  set_fact:
     ansible_host_public_ip: "{{ ansible_host_public_ip.ansible_facts.ipify_public_ip }}"

- name: Debug ansible_host_public_ip
  debug:
    var: ansible_host_public_ip
    verbosity: "1"
